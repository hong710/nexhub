{% extends "base.html" %}
{% block title %}Servers - NexHub{% endblock %}
{% block content %}
<div class="bg-white flex-1 flex flex-col overflow-hidden min-h-0">
    <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between px-2 pt-2 flex-shrink-0">
        <div class="flex items-center gap-3 flex-wrap">
            <div class="flex items-center gap-2 text-blue-900">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="4" y="4" width="16" height="6" rx="1.5" ry="1.5"></rect>
                    <rect x="4" y="14" width="16" height="6" rx="1.5" ry="1.5"></rect>
                    <circle cx="8" cy="7" r="0.75"></circle>
                    <circle cx="8" cy="17" r="0.75"></circle>
                </svg>
                <h1 class="text-2xl font-semibold text-slate-900">Servers</h1>
            </div>
            <form
                id="filters"
                hx-get="."
                hx-target="#server-table-wrapper"
                hx-trigger="keyup changed delay:250ms from:#search, submit"
                hx-swap="innerHTML"
                class="flex items-center gap-2"
            >
                <input
                    id="search"
                    type="search"
                    name="q"
                    value="{{ query }}"
                    placeholder="Global search"
                    class="w-72 rounded-lg border-slate-300 focus:border-blue-600 focus:ring-blue-600 shadow-sm text-sm"
                />
            </form>
        </div>
        <div class="flex flex-wrap items-center gap-2 text-sm text-slate-700 px-1">
            <span class="font-medium text-slate-800 mr-1">Toggle columns:</span>
            {% for col_key, col_label in col_toggles %}
            <label class="inline-flex items-center gap-2 px-2.5 py-1 rounded-full border border-slate-200 bg-white shadow-sm hover:border-blue-500 hover:text-blue-700">
                <input type="checkbox" data-toggle-col="{{ col_key }}" class="rounded border-slate-300" />
                <span class="text-xs font-medium">{{ col_label }}</span>
            </label>
            {% endfor %}
            <button
                type="button"
                id="reset-table"
                class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white border border-slate-200 text-slate-800 shadow-sm hover:border-blue-500 hover:text-blue-700"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v6h6M20 20v-6h-6M20 4h-6m0 0L20 10M8 20h6m0 0L8 14" />
                </svg>
                <span class="text-xs font-medium">Clear Filters</span>
            </button>
            <a
                href="{% url 'overwatch:server_create' %}"
                class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-700 border border-blue-700 text-white shadow-sm hover:bg-blue-800"
            >
                <span class="text-xs font-medium">+</span>
            </a>
        </div>
    </div>

    <div class="h-3 flex-shrink-0"></div>

    <div id="server-table-wrapper" class="flex-1 overflow-hidden min-h-0 px-0">
        {% include "overwatch/server_list_partial.html" %}
    </div>
</div>

<script>
    function persistColumnToggles() {
        const toggles = document.querySelectorAll('[data-toggle-col]');
        const state = {};
        toggles.forEach((t) => (state[t.dataset.toggleCol] = t.checked));
        localStorage.setItem('columnToggles_v2', JSON.stringify(state));
    }

    function applyColumnToggles() {
        const toggles = document.querySelectorAll('[data-toggle-col]');
        toggles.forEach((toggle) => {
            const col = toggle.dataset.toggleCol;
            const show = toggle.checked;
            document.querySelectorAll(`[data-col="${col}"]`).forEach((el) => {
                el.classList.toggle('hidden', !show);
            });
        });
        persistColumnToggles();
    }

    function attachTableReset() {
        const btn = document.getElementById('reset-table');
        if (!btn) return;
        btn.addEventListener('click', () => {
            // Clear search input
            const searchInput = document.getElementById('search');
            if (searchInput) searchInput.value = '';
            
            // Clear all active filters
            window.__activeFilterState = {};
            
            // Trigger HTMX request to reload table data without any filters
            htmx.ajax('GET', window.location.pathname, {
                target: '#server-table-wrapper',
                swap: 'innerHTML'
            }).then(() => {
                // Re-apply column toggles after table reload
                applyColumnToggles();
                // Update filter indicators to show no active filters
                updateFilterIndicators();
            });
        });
    }

    function initColumnFilters() {
        const headers = document.querySelectorAll('th[data-col]');
        headers.forEach((header) => {
            const col = header.dataset.col;
            const panel = header.querySelector(`[data-filter-panel="${col}"]`);
            const btn = header.querySelector(`[data-filter-btn="${col}"]`);
            if (!panel || !btn) return;
            const tagOptions = header.dataset.tagOptions ? header.dataset.tagOptions.split(',').filter(Boolean) : null;

            // Special handling for date columns
            if (col === 'updated_at') {
                const buildDatePanel = () => {
                    let selectedPreset = window.__dateFilterState?.preset || null;
                    let customStart = window.__dateFilterState?.startDate || '';
                    let customEnd = window.__dateFilterState?.endDate || '';

                    panel.innerHTML = `
                        <div class="p-3 space-y-3 text-slate-800 w-64">
                            <div class="space-y-2">
                                <label class="flex items-center gap-2 text-xs text-slate-700 cursor-pointer">
                                    <input type="radio" name="date-preset" value="today" ${selectedPreset === 'today' ? 'checked' : ''} class="rounded border-slate-300" />
                                    <span>Today</span>
                                </label>
                                <label class="flex items-center gap-2 text-xs text-slate-700 cursor-pointer">
                                    <input type="radio" name="date-preset" value="yesterday" ${selectedPreset === 'yesterday' ? 'checked' : ''} class="rounded border-slate-300" />
                                    <span>Yesterday</span>
                                </label>
                                <label class="flex items-center gap-2 text-xs text-slate-700 cursor-pointer">
                                    <input type="radio" name="date-preset" value="last7" ${selectedPreset === 'last7' ? 'checked' : ''} class="rounded border-slate-300" />
                                    <span>Last 7 days</span>
                                </label>
                                <label class="flex items-center gap-2 text-xs text-slate-700 cursor-pointer">
                                    <input type="radio" name="date-preset" value="last30" ${selectedPreset === 'last30' ? 'checked' : ''} class="rounded border-slate-300" />
                                    <span>Last 30 days</span>
                                </label>
                                <label class="flex items-center gap-2 text-xs text-slate-700 cursor-pointer">
                                    <input type="radio" name="date-preset" value="thisMonth" ${selectedPreset === 'thisMonth' ? 'checked' : ''} class="rounded border-slate-300" />
                                    <span>This month</span>
                                </label>
                                <label class="flex items-center gap-2 text-xs text-slate-700 cursor-pointer">
                                    <input type="radio" name="date-preset" value="lastMonth" ${selectedPreset === 'lastMonth' ? 'checked' : ''} class="rounded border-slate-300" />
                                    <span>Last month</span>
                                </label>
                                <label class="flex items-center gap-2 text-xs text-slate-700 cursor-pointer">
                                    <input type="radio" name="date-preset" value="allTime" ${selectedPreset === 'allTime' ? 'checked' : ''} class="rounded border-slate-300" />
                                    <span>All time</span>
                                </label>
                                <label class="flex items-center gap-2 text-xs text-slate-700 cursor-pointer">
                                    <input type="radio" name="date-preset" value="custom" ${selectedPreset === 'custom' ? 'checked' : ''} class="rounded border-slate-300" />
                                    <span>Custom range</span>
                                </label>
                            </div>

                            <div class="custom-date-range space-y-2 ${selectedPreset === 'custom' ? '' : 'hidden'}">
                                <div class="space-y-1">
                                    <label class="text-xs font-semibold text-slate-700">Start date</label>
                                    <input type="date" class="date-start w-full rounded border border-slate-300 text-xs px-2 py-1" value="${customStart}" />
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-semibold text-slate-700">End date</label>
                                    <input type="date" class="date-end w-full rounded border border-slate-300 text-xs px-2 py-1" value="${customEnd}" />
                                </div>
                            </div>

                            <div class="flex items-center gap-2 justify-end text-xs pt-1">
                                <button type="button" data-filter-apply="${col}" class="px-3 py-1 rounded bg-blue-600 text-white border border-blue-600 hover:bg-blue-700">Apply</button>
                                <button type="button" data-filter-cancel="${col}" class="px-3 py-1 rounded bg-slate-100 border border-slate-200 hover:bg-slate-200">Cancel</button>
                            </div>
                        </div>
                    `;

                    // Handle radio button changes
                    const radios = panel.querySelectorAll('input[name="date-preset"]');
                    const customRangeDiv = panel.querySelector('.custom-date-range');
                    radios.forEach((radio) => {
                        radio.addEventListener('change', () => {
                            if (radio.value === 'custom') {
                                customRangeDiv.classList.remove('hidden');
                            } else {
                                customRangeDiv.classList.add('hidden');
                            }
                        });
                    });

                    // Handle apply button
                    const applyBtn = panel.querySelector(`[data-filter-apply="${col}"]`);
                    applyBtn.addEventListener('click', () => {
                        const selectedRadio = panel.querySelector('input[name="date-preset"]:checked');
                        const preset = selectedRadio?.value;
                        
                        if (!window.__dateFilterState) {
                            window.__dateFilterState = {};
                        }

                        if (preset === 'custom') {
                            const startDate = panel.querySelector('.date-start').value;
                            const endDate = panel.querySelector('.date-end').value;
                            if (!startDate || !endDate) {
                                alert('Please select both start and end dates');
                                return;
                            }
                            window.__dateFilterState = { preset: 'custom', startDate, endDate };
                        } else {
                            window.__dateFilterState = { preset };
                        }

                        applyFilters();
                        panel.classList.add('hidden');
                    });

                    // Handle cancel button
                    const cancelBtn = panel.querySelector(`[data-filter-cancel="${col}"]`);
                    cancelBtn.addEventListener('click', () => {
                        panel.classList.add('hidden');
                    });
                };

                btn.addEventListener('click', () => {
                    const currentlyOpen = document.querySelectorAll('[data-filter-panel]');
                    currentlyOpen.forEach((p) => {
                        if (p !== panel) p.classList.add('hidden');
                    });
                    buildDatePanel();
                    panel.classList.toggle('hidden');
                    if (!panel.classList.contains('hidden')) {
                        const rect = panel.getBoundingClientRect();
                        if (rect.top < 0) {
                            panel.style.marginTop = `${Math.abs(rect.top) + 8}px`;
                        } else {
                            panel.style.marginTop = "0";
                        }
                        let shift = 0;
                        if (rect.left < 8) {
                            shift = 8 - rect.left;
                        } else if (rect.right > window.innerWidth - 8) {
                            shift = (window.innerWidth - 8) - rect.right;
                        }
                        panel.style.marginLeft = `${shift}px`;
                    }
                });

                return; // Skip default filter logic for date column
            }

            const buildPanel = () => {
                // Get ALL rows from the table (including hidden ones) to show all distinct values
                const allRows = Array.from(document.querySelectorAll('tbody tr[data-row]'));
                const sourceCells = allRows.flatMap((tr) => Array.from(tr.querySelectorAll(`td[data-col="${col}"]`)));

                let values;
                if (col === 'tags' && tagOptions) {
                    values = tagOptions;
                } else {
                    values = sourceCells
                        .map((td) => td.textContent.trim())
                        .filter((v) => v !== "");
                }
                
                // Sort with IP-aware sorting for IP columns
                let unique;
                if (col === 'tags' && tagOptions) {
                    unique = Array.from(new Set(values));
                } else if (col === 'ip_address' || col === 'bmc_ip') {
                    const ipToString = (ip) => {
                        if (ip === "—") return "999.999.999.999";
                        const parts = ip.split('.');
                        if (parts.length !== 4) return "999.999.999.999";
                        return parts.map(p => String(parseInt(p, 10) || 0).padStart(3, '0')).join('.');
                    };
                    unique = Array.from(new Set(values)).sort((a, b) => ipToString(a).localeCompare(ipToString(b)));
                } else {
                    unique = Array.from(new Set(values)).sort((a, b) => a.localeCompare(b));
                }
                
                let working = new Set(window.__activeFilterState[col] ? Array.from(window.__activeFilterState[col]) : []);

                // Count occurrences of each value
                const valueCounts = {};
                unique.forEach((val) => {
                    valueCounts[val] = sourceCells.filter((td) => {
                        const cellVal = td.textContent.trim();
                        return cellVal === val;
                    }).length;
                });

                const NO_TAG = "__NO_TAG__";

                const renderList = (items) => {
                    return items
                        .map(
                            (val) => `
                            <label class="flex items-center gap-2 text-xs text-slate-700">
                                <input type="checkbox" class="rounded border-slate-300" data-filter-checkbox="${col}" value="${val.replace(/"/g, "&quot;")}" ${working.has(val) ? "checked" : ""} />
                                <span class="truncate" title="${val === NO_TAG ? "No tag" : val}">${val === NO_TAG ? "No tag" : (val || "—")}</span>
                            </label>
                        `
                        )
                        .join("");
                };

                panel.innerHTML = `
                    <div class="p-3 space-y-3 text-slate-800">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <input type="search" placeholder="Search values" data-filter-search="${col}"
                                    class="w-full rounded border-slate-300 focus:border-blue-600 focus:ring-blue-600 text-xs px-2 py-1">
                                <div class="flex flex-col gap-1">
                                    <button type="button" data-filter-sort="${col}" data-dir="asc" class="flex items-center justify-center px-2 py-1 rounded bg-white text-xs border border-slate-200 hover:bg-slate-100">
                                        <span class="text-[11px] font-semibold text-blue-700">A</span>
                                        <span class="text-[11px]">Z</span>
                                        <span class="text-xs">↓</span>
                                    </button>
                                    <button type="button" data-filter-sort="${col}" data-dir="desc" class="flex items-center justify-center px-2 py-1 rounded bg-white text-xs border border-slate-200 hover:bg-slate-100">
                                        <span class="text-[11px] font-semibold text-blue-700">Z</span>
                                        <span class="text-[11px]">A</span>
                                        <span class="text-xs">↓</span>
                                    </button>
                                </div>
                            </div>
                            <span class="text-xs text-slate-500 font-medium ml-2 flex-shrink-0">Total: ${unique.length}</span>
                        </div>
                        <div class="flex items-center gap-2 text-xs">
                            <button type="button" data-filter-selectall="${col}" class="px-2 py-1 rounded bg-slate-100 border border-slate-200 hover:bg-slate-200">Select all</button>
                            <button type="button" data-filter-clear="${col}" class="px-2 py-1 rounded bg-slate-100 border border-slate-200 hover:bg-slate-200">Unselect all</button>
                        </div>
                        <div class="max-h-52 overflow-y-auto space-y-1" data-filter-list="${col}">
                            ${renderList(unique)}
                        </div>
                        <div class="flex items-center gap-2 justify-end text-xs pt-1">
                            <button type="button" data-filter-apply="${col}" class="px-3 py-1 rounded bg-blue-600 text-white border border-blue-600 hover:bg-blue-700">Apply</button>
                            <button type="button" data-filter-cancel="${col}" class="px-3 py-1 rounded bg-slate-100 border border-slate-200 hover:bg-slate-200">Cancel</button>
                        </div>
                    </div>
                `;

                const listEl = panel.querySelector(`[data-filter-list="${col}"]`);
                const searchInput = panel.querySelector(`[data-filter-search="${col}"]`);
                let currentFilteredValues = unique;

                searchInput.addEventListener('input', () => {
                    const term = searchInput.value.toLowerCase();
                    currentFilteredValues = unique.filter((v) => {
                        const label = v === "__NO_TAG__" ? "No tag" : v;
                        return label.toLowerCase().includes(term);
                    });
                    listEl.innerHTML = renderList(currentFilteredValues);
                });

                panel.addEventListener('change', (e) => {
                    if (e.target.matches(`[data-filter-checkbox="${col}"]`)) {
                        const val = e.target.value;
                        if (e.target.checked) {
                            working.add(val);
                        } else {
                            working.delete(val);
                        }
                    }
                });

                panel.addEventListener('click', (e) => {
                    if (e.target.closest(`[data-filter-selectall="${col}"]`)) {
                        // Select all currently filtered values
                        currentFilteredValues.forEach((v) => working.add(v));
                        listEl.innerHTML = renderList(currentFilteredValues);
                        // Check all visible checkboxes
                        listEl.querySelectorAll(`[data-filter-checkbox="${col}"]`).forEach((cb) => {
                            cb.checked = true;
                        });
                    }
                    if (e.target.closest(`[data-filter-clear="${col}"]`)) {
                        // Unselect all currently filtered values
                        currentFilteredValues.forEach((v) => working.delete(v));
                        listEl.innerHTML = renderList(currentFilteredValues);
                        // Uncheck all visible checkboxes
                        listEl.querySelectorAll(`[data-filter-checkbox="${col}"]`).forEach((cb) => {
                            cb.checked = false;
                        });
                    }
                    if (e.target.closest(`[data-filter-sort="${col}"]`)) {
                        const dir = e.target.closest(`[data-filter-sort]`).dataset.dir;
                        sortTable(col, dir);
                    }
                    if (e.target.closest(`[data-filter-apply="${col}"]`)) {
                        window.__activeFilterState[col] = new Set(working);
                        applyFilters();
                        panel.classList.add('hidden');
                    }
                    if (e.target.closest(`[data-filter-cancel="${col}"]`)) {
                        working = new Set(window.__activeFilterState[col] ? Array.from(window.__activeFilterState[col]) : []);
                        listEl.innerHTML = renderList(unique);
                        panel.classList.add('hidden');
                    }
                });
            };

            btn.addEventListener('click', () => {
                const currentlyOpen = document.querySelectorAll('[data-filter-panel]');
                currentlyOpen.forEach((p) => {
                    if (p !== panel) p.classList.add('hidden');
                });
                buildPanel();
                panel.classList.toggle('hidden');
                if (!panel.classList.contains('hidden')) {
                    const rect = panel.getBoundingClientRect();
                    if (rect.top < 0) {
                        panel.style.marginTop = `${Math.abs(rect.top) + 8}px`;
                    } else {
                        panel.style.marginTop = "0";
                    }
                    let shift = 0;
                    if (rect.left < 8) {
                        shift = 8 - rect.left;
                    } else if (rect.right > window.innerWidth - 8) {
                        shift = (window.innerWidth - 8) - rect.right;
                    }
                    panel.style.marginLeft = `${shift}px`;
                }
            });
        });
    }

    function applyFilters() {
        const rows = document.querySelectorAll('tbody tr[data-row]');
        
        // Get date filter state
        const dateState = window.__dateFilterState;
        let dateStart = null, dateEnd = null;
        
        if (dateState) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const last7 = new Date(today);
            last7.setDate(last7.getDate() - 7);
            
            const last30 = new Date(today);
            last30.setDate(last30.getDate() - 30);
            
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            monthEnd.setHours(23, 59, 59, 999);
            
            const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
            lastMonthEnd.setHours(23, 59, 59, 999);
            
            switch(dateState.preset) {
                case 'today':
                    dateStart = today;
                    dateEnd = tomorrow;
                    break;
                case 'yesterday':
                    dateStart = yesterday;
                    dateEnd = today;
                    break;
                case 'last7':
                    dateStart = last7;
                    dateEnd = tomorrow;
                    break;
                case 'last30':
                    dateStart = last30;
                    dateEnd = tomorrow;
                    break;
                case 'thisMonth':
                    dateStart = monthStart;
                    dateEnd = monthEnd;
                    break;
                case 'lastMonth':
                    dateStart = lastMonthStart;
                    dateEnd = lastMonthEnd;
                    break;
                case 'custom':
                    if (dateState.startDate && dateState.endDate) {
                        dateStart = new Date(dateState.startDate);
                        dateStart.setHours(0, 0, 0, 0);
                        dateEnd = new Date(dateState.endDate);
                        dateEnd.setHours(23, 59, 59, 999);
                    }
                    break;
                case 'allTime':
                default:
                    dateStart = null;
                    dateEnd = null;
            }
        }
        
        rows.forEach((row) => {
            let visible = true;
            
            // Check date filter first
            if (dateStart && dateEnd) {
                const cell = row.querySelector('td[data-col="updated_at"]');
                if (cell) {
                    const dateStr = cell.textContent.trim();
                    // Parse "2025-12-13 10:30" format
                    const datePart = dateStr.split(' ')[0];
                    const rowDate = new Date(datePart);
                    rowDate.setHours(12, 0, 0, 0);
                    
                    if (rowDate < dateStart || rowDate > dateEnd) {
                        visible = false;
                    }
                }
            }
            
            // Check other column filters
            if (visible) {
                for (const [col, values] of Object.entries(window.__activeFilterState)) {
                    if (!values || values.size === 0) {
                        continue; // empty means no filter applied on this column
                    }
                    if (col === 'updated_at') {
                        continue; // skip, handled above
                    }
                    const cell = row.querySelector(`td[data-col="${col}"]`);
                    if (!cell) continue;
                    if (col === 'tags') {
                        const raw = cell.dataset.tags || "";
                        const tagList = raw ? raw.split(',').map((t) => t.trim()).filter(Boolean) : [];
                        const hasNoTagSelected = values.has("__NO_TAG__");
                        const hasMatchTag = tagList.some((t) => values.has(t));
                        const hasMatch = (hasNoTagSelected && tagList.length === 0) || hasMatchTag;
                        if (!hasMatch) {
                            visible = false;
                            break;
                        }
                    } else {
                        const cellVal = (cell.textContent || "").trim();
                        if (!values.has(cellVal)) {
                            visible = false;
                            break;
                        }
                    }
                }
            }
            
            row.classList.toggle('hidden', !visible);
        });
        updateFilterIndicators();
        renumberRows();
    }

    function updateVisibleCount() {
        const countEl = document.getElementById('row-count');
        if (!countEl) return;
        const total = parseInt(countEl.dataset.total || "0", 10) || 0;
        const serverFiltered = parseInt(countEl.dataset.filtered || "0", 10) || 0;
        const rows = Array.from(document.querySelectorAll('tbody tr[data-row]')).filter((r) => !r.classList.contains('hidden'));
        const hasFilters = Object.values(window.__activeFilterState || {}).some((set) => set && set.size > 0);
        const displayCount = hasFilters ? rows.length : serverFiltered || rows.length;
        countEl.textContent = `Count ${displayCount} of ${total} rows`;
    }

    function renumberRows() {
        const rows = Array.from(document.querySelectorAll('tbody tr[data-row]')).filter((r) => !r.classList.contains('hidden'));
        rows.forEach((row, idx) => {
            const numCell = row.querySelector('td');
            if (numCell) numCell.textContent = idx + 1;
        });
        updateVisibleCount();
    }

    function updateFilterIndicators() {
        const headers = document.querySelectorAll('th[data-col]');
        headers.forEach((header) => {
            const col = header.dataset.col;
            const active = window.__activeFilterState[col] && window.__activeFilterState[col].size > 0;
            const btn = header.querySelector('[data-filter-btn]');
            if (btn) {
                btn.classList.remove('bg-white/20', 'text-yellow-200', 'ring-2', 'ring-yellow-300');
                if (active) {
                    btn.classList.add('bg-white/20', 'text-yellow-200', 'ring-2', 'ring-yellow-300');
                }
            }
        });
    }

    function sortTable(col, direction) {
        const tbody = document.querySelector('tbody');
        if (!tbody) return;
        const rows = Array.from(tbody.querySelectorAll('tr[data-row]'));
        rows.sort((a, b) => {
            const av = (a.querySelector(`td[data-col="${col}"]`)?.textContent || "").trim();
            const bv = (b.querySelector(`td[data-col="${col}"]`)?.textContent || "").trim();
            
            // IP-aware sorting for IP columns
            if (col === 'ip_address' || col === 'bmc_ip') {
                const ipToString = (ip) => {
                    if (ip === "—") return "999.999.999.999";
                    const parts = ip.split('.');
                    if (parts.length !== 4) return "999.999.999.999";
                    return parts.map(p => String(parseInt(p, 10) || 0).padStart(3, '0')).join('.');
                };
                const strA = ipToString(av);
                const strB = ipToString(bv);
                return direction === 'asc' ? strA.localeCompare(strB) : strB.localeCompare(strA);
            }
            
            // Default string sorting for other columns
            return direction === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av);
        });
        rows.forEach((row) => tbody.appendChild(row));
        renumberRows();
    }

    function isFilterActive() {
        return Object.values(window.__activeFilterState || {}).some((set) => set && set.size > 0);
    }

    function getVisibleRows() {
        return Array.from(document.querySelectorAll('tbody tr[data-row]')).filter((r) => !r.classList.contains('hidden'));
    }

    function persistColumnToggles() {
        const toggles = document.querySelectorAll('[data-toggle-col]');
        const state = {};
        toggles.forEach((t) => (state[t.dataset.toggleCol] = t.checked));
        localStorage.setItem('columnToggles', JSON.stringify(state));
    }

    function applyColumnToggles() {
        const toggles = document.querySelectorAll('[data-toggle-col]');
        toggles.forEach((toggle) => {
            const col = toggle.dataset.toggleCol;
            const show = toggle.checked;
            document.querySelectorAll(`[data-col="${col}"]`).forEach((el) => {
                el.classList.toggle('hidden', !show);
            });
        });
        persistColumnToggles();
    }

    function initUI() {
        window.__activeFilterState = {};
        // restore toggle state (default to on if missing)
        const saved = localStorage.getItem('columnToggles_v2');
        const toggles = Array.from(document.querySelectorAll('[data-toggle-col]'));
        const defaultState = {};
        const hiddenByDefault = ['disk_count', 'data_source', 'tags', 'manufacture', 'bios_version', 'product_name'];
        toggles.forEach((t) => {
            defaultState[t.dataset.toggleCol] = hiddenByDefault.includes(t.dataset.toggleCol) ? false : true;
        });
        let restored = { ...defaultState };
        if (saved) {
            try {
                const state = JSON.parse(saved);
                restored = { ...defaultState, ...state };
            } catch (e) {
                console.warn('Could not parse column toggle state', e);
            }
        }
        toggles.forEach((t) => {
            if (restored.hasOwnProperty(t.dataset.toggleCol)) {
                t.checked = restored[t.dataset.toggleCol];
            }
        });
        applyColumnToggles();
        attachTableReset();
        initColumnFilters();
        updateFilterIndicators();
        renumberRows();
    }

    document.addEventListener('change', (event) => {
        if (event.target.matches('[data-toggle-col]')) {
            applyColumnToggles();
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        initUI();
    });
    document.body.addEventListener('htmx:afterSwap', (e) => {
        if (e.target && e.target.id === 'server-table-wrapper') {
            initUI();
        }
    });

    // No HTMX afterSwap needed; using full page reload for pagination/page size
</script>
{% endblock %}

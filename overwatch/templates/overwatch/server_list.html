{% extends "base.html" %}
{% block title %}Servers - NexHub{% endblock %}
{% block content %}
<div class="bg-white flex-1 flex flex-col overflow-hidden min-h-0">
    <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between px-2 pt-2 flex-shrink-0">
        <div class="flex items-center gap-3 flex-wrap">
            <div class="flex items-center gap-2 text-blue-900">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="4" y="4" width="16" height="6" rx="1.5" ry="1.5"></rect>
                    <rect x="4" y="14" width="16" height="6" rx="1.5" ry="1.5"></rect>
                    <circle cx="8" cy="7" r="0.75"></circle>
                    <circle cx="8" cy="17" r="0.75"></circle>
                </svg>
                <h1 class="text-2xl font-semibold text-slate-900">Servers</h1>
            </div>
            <form
                id="filters"
                hx-get="."
                hx-target="#server-table-wrapper"
                hx-trigger="keyup changed delay:250ms from:#search, submit"
                hx-include="#page-size-select"
                hx-swap="innerHTML"
                class="flex items-center gap-2"
            >
                <input
                    id="search"
                    type="search"
                    name="q"
                    value="{{ query }}"
                    placeholder="Global search"
                    class="w-72 rounded-lg border-slate-300 focus:border-blue-600 focus:ring-blue-600 shadow-sm text-sm"
                />
                <input type="hidden" name="page_size" value="{{ page_size }}">
            </form>
        </div>
        <div class="flex flex-wrap items-center gap-2 text-sm text-slate-700 px-1">
            <span class="font-medium text-slate-800 mr-1">Toggle columns:</span>
            {% for col_key, col_label in col_toggles %}
            <label class="inline-flex items-center gap-2 px-2.5 py-1 rounded-full border border-slate-200 bg-white shadow-sm hover:border-blue-500 hover:text-blue-700">
                <input type="checkbox" data-toggle-col="{{ col_key }}" class="rounded border-slate-300" />
                <span class="text-xs font-medium">{{ col_label }}</span>
            </label>
            {% endfor %}
            <button
                type="button"
                id="reset-table"
                class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white border border-slate-200 text-slate-800 shadow-sm hover:border-blue-500 hover:text-blue-700"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v6h6M20 20v-6h-6M20 4h-6m0 0L20 10M8 20h6m0 0L8 14" />
                </svg>
                <span class="text-xs font-medium">Reset</span>
            </button>
            <a
                href="{% url 'overwatch:server_create' %}"
                class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-700 border border-blue-700 text-white shadow-sm hover:bg-blue-800"
            >
                <span class="text-xs font-medium">+</span>
            </a>
        </div>
    </div>

    <div class="h-3 flex-shrink-0"></div>

    <div id="server-table-wrapper" class="flex-1 overflow-hidden min-h-0 px-0">
        {% include "overwatch/server_list_partial.html" %}
    </div>
</div>

<script>
    function persistColumnToggles() {
        const toggles = document.querySelectorAll('[data-toggle-col]');
        const state = {};
        toggles.forEach((t) => (state[t.dataset.toggleCol] = t.checked));
        localStorage.setItem('columnToggles_v2', JSON.stringify(state));
    }

    function applyColumnToggles() {
        const toggles = document.querySelectorAll('[data-toggle-col]');
        toggles.forEach((toggle) => {
            const col = toggle.dataset.toggleCol;
            const show = toggle.checked;
            document.querySelectorAll(`[data-col="${col}"]`).forEach((el) => {
                el.classList.toggle('hidden', !show);
            });
        });
        persistColumnToggles();
    }

    function attachTableReset() {
        const btn = document.getElementById('reset-table');
        if (!btn) return;
        btn.addEventListener('click', () => {
            window.location.href = window.location.pathname;
        });
    }

    function initColumnFilters() {
        const headers = document.querySelectorAll('th[data-col]');
        headers.forEach((header) => {
            const col = header.dataset.col;
            const panel = header.querySelector(`[data-filter-panel="${col}"]`);
            const btn = header.querySelector(`[data-filter-btn="${col}"]`);
            if (!panel || !btn) return;
            const tagOptions = header.dataset.tagOptions ? header.dataset.tagOptions.split(',').filter(Boolean) : null;

            const buildPanel = () => {
                // Get ALL rows from the table (including hidden ones) to show all distinct values
                const allRows = Array.from(document.querySelectorAll('tbody tr[data-row]'));
                const sourceCells = allRows.flatMap((tr) => Array.from(tr.querySelectorAll(`td[data-col="${col}"]`)));

                let values;
                if (col === 'tags' && tagOptions) {
                    values = tagOptions;
                } else {
                    values = sourceCells
                        .map((td) => td.textContent.trim())
                        .filter((v) => v !== "");
                }
                
                // Sort with IP-aware sorting for IP columns
                let unique;
                if (col === 'tags' && tagOptions) {
                    unique = Array.from(new Set(values));
                } else if (col === 'ip_address' || col === 'bmc_ip') {
                    const ipToString = (ip) => {
                        if (ip === "—") return "999.999.999.999";
                        const parts = ip.split('.');
                        if (parts.length !== 4) return "999.999.999.999";
                        return parts.map(p => String(parseInt(p, 10) || 0).padStart(3, '0')).join('.');
                    };
                    unique = Array.from(new Set(values)).sort((a, b) => ipToString(a).localeCompare(ipToString(b)));
                } else {
                    unique = Array.from(new Set(values)).sort((a, b) => a.localeCompare(b));
                }
                
                let working = new Set(window.__activeFilterState[col] ? Array.from(window.__activeFilterState[col]) : []);

                // Count occurrences of each value
                const valueCounts = {};
                unique.forEach((val) => {
                    valueCounts[val] = sourceCells.filter((td) => {
                        const cellVal = td.textContent.trim();
                        return cellVal === val;
                    }).length;
                });

                const NO_TAG = "__NO_TAG__";

                const renderList = (items) => {
                    return items
                        .map(
                            (val) => `
                            <label class="flex items-center gap-2 text-xs text-slate-700">
                                <input type="checkbox" class="rounded border-slate-300" data-filter-checkbox="${col}" value="${val.replace(/"/g, "&quot;")}" ${working.has(val) ? "checked" : ""} />
                                <span class="truncate" title="${val === NO_TAG ? "No tag" : val}">${val === NO_TAG ? "No tag" : (val || "—")}</span>
                            </label>
                        `
                        )
                        .join("");
                };

                panel.innerHTML = `
                    <div class="p-3 space-y-3 text-slate-800">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <input type="search" placeholder="Search values" data-filter-search="${col}"
                                    class="w-full rounded border-slate-300 focus:border-blue-600 focus:ring-blue-600 text-xs px-2 py-1">
                                <div class="flex flex-col gap-1">
                                    <button type="button" data-filter-sort="${col}" data-dir="asc" class="flex items-center justify-center px-2 py-1 rounded bg-white text-xs border border-slate-200 hover:bg-slate-100">
                                        <span class="text-[11px] font-semibold text-blue-700">A</span>
                                        <span class="text-[11px]">Z</span>
                                        <span class="text-xs">↓</span>
                                    </button>
                                    <button type="button" data-filter-sort="${col}" data-dir="desc" class="flex items-center justify-center px-2 py-1 rounded bg-white text-xs border border-slate-200 hover:bg-slate-100">
                                        <span class="text-[11px] font-semibold text-blue-700">Z</span>
                                        <span class="text-[11px]">A</span>
                                        <span class="text-xs">↓</span>
                                    </button>
                                </div>
                            </div>
                            <span class="text-xs text-slate-500 font-medium ml-2 flex-shrink-0">Total: ${unique.length}</span>
                        </div>
                        <div class="flex items-center gap-2 text-xs">
                            <button type="button" data-filter-selectall="${col}" class="px-2 py-1 rounded bg-slate-100 border border-slate-200 hover:bg-slate-200">Select all</button>
                            <button type="button" data-filter-clear="${col}" class="px-2 py-1 rounded bg-slate-100 border border-slate-200 hover:bg-slate-200">Unselect all</button>
                        </div>
                        <div class="max-h-52 overflow-y-auto space-y-1" data-filter-list="${col}">
                            ${renderList(unique)}
                        </div>
                        <div class="flex items-center gap-2 justify-end text-xs pt-1">
                            <button type="button" data-filter-apply="${col}" class="px-3 py-1 rounded bg-blue-600 text-white border border-blue-600 hover:bg-blue-700">Apply</button>
                            <button type="button" data-filter-cancel="${col}" class="px-3 py-1 rounded bg-slate-100 border border-slate-200 hover:bg-slate-200">Cancel</button>
                        </div>
                    </div>
                `;

                const listEl = panel.querySelector(`[data-filter-list="${col}"]`);
                const searchInput = panel.querySelector(`[data-filter-search="${col}"]`);
                let currentFilteredValues = unique;

                searchInput.addEventListener('input', () => {
                    const term = searchInput.value.toLowerCase();
                    currentFilteredValues = unique.filter((v) => {
                        const label = v === "__NO_TAG__" ? "No tag" : v;
                        return label.toLowerCase().includes(term);
                    });
                    listEl.innerHTML = renderList(currentFilteredValues);
                });

                panel.addEventListener('change', (e) => {
                    if (e.target.matches(`[data-filter-checkbox="${col}"]`)) {
                        const val = e.target.value;
                        if (e.target.checked) {
                            working.add(val);
                        } else {
                            working.delete(val);
                        }
                    }
                });

                panel.addEventListener('click', (e) => {
                    if (e.target.closest(`[data-filter-selectall="${col}"]`)) {
                        // Select all currently filtered values
                        currentFilteredValues.forEach((v) => working.add(v));
                        listEl.innerHTML = renderList(currentFilteredValues);
                        // Check all visible checkboxes
                        listEl.querySelectorAll(`[data-filter-checkbox="${col}"]`).forEach((cb) => {
                            cb.checked = true;
                        });
                    }
                    if (e.target.closest(`[data-filter-clear="${col}"]`)) {
                        // Unselect all currently filtered values
                        currentFilteredValues.forEach((v) => working.delete(v));
                        listEl.innerHTML = renderList(currentFilteredValues);
                        // Uncheck all visible checkboxes
                        listEl.querySelectorAll(`[data-filter-checkbox="${col}"]`).forEach((cb) => {
                            cb.checked = false;
                        });
                    }
                    if (e.target.closest(`[data-filter-sort="${col}"]`)) {
                        const dir = e.target.closest(`[data-filter-sort]`).dataset.dir;
                        sortTable(col, dir);
                    }
                    if (e.target.closest(`[data-filter-apply="${col}"]`)) {
                        window.__activeFilterState[col] = new Set(working);
                        applyFilters();
                        panel.classList.add('hidden');
                    }
                    if (e.target.closest(`[data-filter-cancel="${col}"]`)) {
                        working = new Set(window.__activeFilterState[col] ? Array.from(window.__activeFilterState[col]) : []);
                        listEl.innerHTML = renderList(unique);
                        panel.classList.add('hidden');
                    }
                });
            };

            btn.addEventListener('click', () => {
                const currentlyOpen = document.querySelectorAll('[data-filter-panel]');
                currentlyOpen.forEach((p) => {
                    if (p !== panel) p.classList.add('hidden');
                });
                buildPanel();
                panel.classList.toggle('hidden');
                if (!panel.classList.contains('hidden')) {
                    const rect = panel.getBoundingClientRect();
                    if (rect.top < 0) {
                        panel.style.marginTop = `${Math.abs(rect.top) + 8}px`;
                    } else {
                        panel.style.marginTop = "0";
                    }
                    let shift = 0;
                    if (rect.left < 8) {
                        shift = 8 - rect.left;
                    } else if (rect.right > window.innerWidth - 8) {
                        shift = (window.innerWidth - 8) - rect.right;
                    }
                    panel.style.marginLeft = `${shift}px`;
                }
            });
        });
    }

    function applyFilters() {
        const rows = document.querySelectorAll('tbody tr[data-row]');
        rows.forEach((row) => {
            let visible = true;
            for (const [col, values] of Object.entries(window.__activeFilterState)) {
                if (!values || values.size === 0) {
                    continue; // empty means no filter applied on this column
                }
                const cell = row.querySelector(`td[data-col="${col}"]`);
                if (!cell) continue;
                if (col === 'tags') {
                    const raw = cell.dataset.tags || "";
                    const tagList = raw ? raw.split(',').map((t) => t.trim()).filter(Boolean) : [];
                    const hasNoTagSelected = values.has("__NO_TAG__");
                    const hasMatchTag = tagList.some((t) => values.has(t));
                    const hasMatch = (hasNoTagSelected && tagList.length === 0) || hasMatchTag;
                    if (!hasMatch) {
                        visible = false;
                        break;
                    }
                } else {
                    const cellVal = (cell.textContent || "").trim();
                    if (!values.has(cellVal)) {
                        visible = false;
                        break;
                    }
                }
            }
            row.classList.toggle('hidden', !visible);
        });
        updateFilterIndicators();
        renumberRows();
        refreshPagination();
    }

    function updateVisibleCount() {
        const countEl = document.getElementById('row-count');
        if (!countEl) return;
        const total = parseInt(countEl.dataset.total || "0", 10) || 0;
        const serverFiltered = parseInt(countEl.dataset.filtered || "0", 10) || 0;
        const rows = Array.from(document.querySelectorAll('tbody tr[data-row]')).filter((r) => !r.classList.contains('hidden'));
        const hasFilters = Object.values(window.__activeFilterState || {}).some((set) => set && set.size > 0);
        const displayCount = hasFilters ? rows.length : serverFiltered || rows.length;
        countEl.textContent = `Count ${displayCount} of ${total} rows`;
    }

    function renumberRows() {
        const rows = Array.from(document.querySelectorAll('tbody tr[data-row]')).filter((r) => !r.classList.contains('hidden'));
        const hasFilters = Object.values(window.__activeFilterState || {}).some((set) => set && set.size > 0);
        if (hasFilters) {
            const pageSize = window.__clientPageSize || rows.length || 1;
            const page = window.__clientPage || 1;
            const startIndex = (page - 1) * pageSize;
            rows.forEach((row, idx) => {
                const numCell = row.querySelector('td');
                if (numCell) numCell.textContent = startIndex + idx + 1;
            });
        }
        updateVisibleCount();
    }

    function updateFilterIndicators() {
        const headers = document.querySelectorAll('th[data-col]');
        headers.forEach((header) => {
            const col = header.dataset.col;
            const active = window.__activeFilterState[col] && window.__activeFilterState[col].size > 0;
            const btn = header.querySelector('[data-filter-btn]');
            if (btn) {
                btn.classList.remove('bg-white/20', 'text-yellow-200', 'ring-2', 'ring-yellow-300');
                if (active) {
                    btn.classList.add('bg-white/20', 'text-yellow-200', 'ring-2', 'ring-yellow-300');
                }
            }
        });
    }

    function sortTable(col, direction) {
        const tbody = document.querySelector('tbody');
        if (!tbody) return;
        const rows = Array.from(tbody.querySelectorAll('tr[data-row]'));
        rows.sort((a, b) => {
            const av = (a.querySelector(`td[data-col="${col}"]`)?.textContent || "").trim();
            const bv = (b.querySelector(`td[data-col="${col}"]`)?.textContent || "").trim();
            
            // IP-aware sorting for IP columns
            if (col === 'ip_address' || col === 'bmc_ip') {
                const ipToString = (ip) => {
                    if (ip === "—") return "999.999.999.999";
                    const parts = ip.split('.');
                    if (parts.length !== 4) return "999.999.999.999";
                    return parts.map(p => String(parseInt(p, 10) || 0).padStart(3, '0')).join('.');
                };
                const strA = ipToString(av);
                const strB = ipToString(bv);
                return direction === 'asc' ? strA.localeCompare(strB) : strB.localeCompare(strA);
            }
            
            // Default string sorting for other columns
            return direction === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av);
        });
        rows.forEach((row) => tbody.appendChild(row));
        renumberRows();
    }

    function isFilterActive() {
        return Object.values(window.__activeFilterState || {}).some((set) => set && set.size > 0);
    }

    function getVisibleRows() {
        return Array.from(document.querySelectorAll('tbody tr[data-row]')).filter((r) => !r.classList.contains('hidden'));
    }

    function applyClientPaging() {
        if (!isFilterActive()) return;
        const rows = getVisibleRows();
        const pageSize = window.__clientPageSize || rows.length || 1;
        const page = Math.max(1, Math.min(window.__clientPage || 1, Math.ceil((rows.length || 1) / pageSize)));
        window.__clientPage = page;
        const start = (page - 1) * pageSize;
        const end = start + pageSize;
        rows.forEach((row, idx) => {
            if (idx >= start && idx < end) {
                row.classList.remove('hidden-by-page');
            } else {
                row.classList.add('hidden-by-page');
            }
        });
        renumberRows();
    }

    function refreshPagination() {
        const pageNumbers = document.getElementById('page-numbers');
        const pageStatus = document.getElementById('page-status');
        const pageSizeSelect = document.getElementById('page-size-select');
        if (!pageNumbers || !pageStatus || !pageSizeSelect) return;

        if (!isFilterActive()) {
            // restore any option disabling
            Array.from(pageSizeSelect.options).forEach((opt) => (opt.disabled = false));
            pageSizeSelect.disabled = false;
            return;
        }

        const rows = getVisibleRows();
        const count = rows.length;
        const allowedSizes = Array.from(pageSizeSelect.options).map((o) => parseInt(o.value, 10)).filter((v) => !isNaN(v));
        let selectedSize = parseInt(pageSizeSelect.value, 10);
        if (!selectedSize || selectedSize > count) {
            selectedSize = count || allowedSizes[0] || 25;
        }

        // disable options larger than count
        Array.from(pageSizeSelect.options).forEach((opt) => {
            const val = parseInt(opt.value, 10);
            opt.disabled = count > 0 ? val > count : false;
        });
        pageSizeSelect.value = selectedSize;
        pageSizeSelect.disabled = count <= Math.min(...allowedSizes);

        window.__clientPageSize = selectedSize;
        const totalPages = Math.max(1, Math.ceil((count || 1) / selectedSize));
        if (!window.__clientPage || window.__clientPage > totalPages) {
            window.__clientPage = 1;
        }

        // rebuild page numbers
        pageNumbers.innerHTML = "";
        for (let p = 1; p <= totalPages; p++) {
            const el = document.createElement(p === window.__clientPage ? 'span' : 'a');
            el.textContent = p;
            el.dataset.page = p;
            el.className = p === window.__clientPage
                ? "px-3 py-2 text-sm bg-blue-600 text-white rounded border border-blue-600 js-page-link"
                : "px-3 py-2 text-sm bg-white border border-slate-200 rounded hover:bg-blue-50 text-slate-800 js-page-link";
            el.href = "#";
            el.addEventListener('click', (ev) => {
                ev.preventDefault();
                window.__clientPage = p;
                applyClientPaging();
                refreshPagination();
            });
            pageNumbers.appendChild(el);
        }

        // update status text
        pageStatus.textContent = `Page ${window.__clientPage} of ${totalPages}`;

        // update nav buttons
        const navMap = {
            first: 1,
            prev: Math.max(1, window.__clientPage - 1),
            next: Math.min(totalPages, window.__clientPage + 1),
            last: totalPages,
        };
        document.querySelectorAll('.js-page-link[data-nav]').forEach((el) => {
            const nav = el.dataset.nav;
            const target = navMap[nav];
            const disabled = (nav === 'first' && window.__clientPage === 1) ||
                (nav === 'prev' && window.__clientPage === 1) ||
                (nav === 'next' && window.__clientPage === totalPages) ||
                (nav === 'last' && window.__clientPage === totalPages);
            el.classList.toggle('pointer-events-none', disabled);
            el.classList.toggle('opacity-50', disabled);
            el.addEventListener('click', (ev) => {
                ev.preventDefault();
                if (disabled) return;
                window.__clientPage = target;
                applyClientPaging();
                refreshPagination();
            });
        });

        applyClientPaging();
    }

    function persistColumnToggles() {
        const toggles = document.querySelectorAll('[data-toggle-col]');
        const state = {};
        toggles.forEach((t) => (state[t.dataset.toggleCol] = t.checked));
        localStorage.setItem('columnToggles', JSON.stringify(state));
    }

    function applyColumnToggles() {
        const toggles = document.querySelectorAll('[data-toggle-col]');
        toggles.forEach((toggle) => {
            const col = toggle.dataset.toggleCol;
            const show = toggle.checked;
            document.querySelectorAll(`[data-col="${col}"]`).forEach((el) => {
                el.classList.toggle('hidden', !show);
            });
        });
        persistColumnToggles();
    }

    function initUI() {
        window.__activeFilterState = {};
        // restore toggle state (default to on if missing)
        const saved = localStorage.getItem('columnToggles_v2');
        const toggles = Array.from(document.querySelectorAll('[data-toggle-col]'));
        const defaultState = {};
        const hiddenByDefault = ['disk_count', 'data_source', 'tags', 'manufacture', 'bios_version', 'product_name'];
        toggles.forEach((t) => {
            defaultState[t.dataset.toggleCol] = hiddenByDefault.includes(t.dataset.toggleCol) ? false : true;
        });
        let restored = { ...defaultState };
        if (saved) {
            try {
                const state = JSON.parse(saved);
                restored = { ...defaultState, ...state };
            } catch (e) {
                console.warn('Could not parse column toggle state', e);
            }
        }
        toggles.forEach((t) => {
            if (restored.hasOwnProperty(t.dataset.toggleCol)) {
                t.checked = restored[t.dataset.toggleCol];
            }
        });
        applyColumnToggles();
        attachTableReset();
        initColumnFilters();
        updateFilterIndicators();
        // page size select submit form
        const pageSizeSelect = document.getElementById('page-size-select');
        if (pageSizeSelect) {
            pageSizeSelect.addEventListener('change', (e) => {
                if (isFilterActive()) {
                    window.__clientPageSize = parseInt(pageSizeSelect.value, 10) || window.__clientPageSize;
                    window.__clientPage = 1;
                    refreshPagination();
                    applyClientPaging();
                } else {
                    const form = document.getElementById('filters');
                    if (form) form.submit();
                }
            });
        }
        renumberRows();
        refreshPagination();
    }

    document.addEventListener('change', (event) => {
        if (event.target.matches('[data-toggle-col]')) {
            applyColumnToggles();
            if (isFilterActive()) {
                window.__clientPage = 1;
                refreshPagination();
            }
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        initUI();
    });
    document.body.addEventListener('htmx:afterSwap', (e) => {
        if (e.target && e.target.id === 'server-table-wrapper') {
            initUI();
        }
    });

    // No HTMX afterSwap needed; using full page reload for pagination/page size
</script>
{% endblock %}

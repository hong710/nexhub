{% extends "base.html" %}
{% block title %}{{ form_title|default:"Server" }} - NexHub{% endblock %}
{% block content %}
<div class="h-full flex flex-col overflow-hidden bg-slate-100">
    <!-- Header Bar -->
    <div class="bg-white border-b border-slate-200 shadow-sm flex-shrink-0 z-10">
        <div class="max-w-6xl mx-auto px-6 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <a href="{% if form.instance.pk %}{% url 'overwatch:server_detail' form.instance.pk %}{% else %}{% url 'overwatch:server_list' %}{% endif %}" 
                       class="inline-flex items-center gap-2 text-sm text-slate-600 hover:text-blue-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                        </svg>
                        Back
                    </a>
                    <div class="h-5 w-px bg-slate-300"></div>
                    <h1 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                        </svg>
                        {{ form_title|default:"Edit Server" }}
                    </h1>
                </div>
                <div class="flex items-center gap-3">
                    <a href="{% if form.instance.pk %}{% url 'overwatch:server_detail' form.instance.pk %}{% else %}{% url 'overwatch:server_list' %}{% endif %}" 
                       class="px-4 py-2 text-sm font-medium text-slate-600 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors">
                        Cancel
                    </a>
                    <button type="submit" form="server-form" 
                            class="px-5 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-200 transition-all inline-flex items-center gap-2 shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                        </svg>
                        {{ submit_label|default:"Save Changes" }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scrollable Form Content -->
    <div class="flex-1 overflow-y-auto">
        <div class="max-w-6xl mx-auto px-6 py-5 pb-8">
            <form id="server-form" method="post" action="{{ form_action|default:request.path }}" class="space-y-4">
                {% csrf_token %}

                <!-- Row 1: Basic Info + Network -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <!-- Basic Information -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="px-4 py-2.5 bg-gradient-to-r from-blue-100 to-indigo-100 border-b border-blue-200">
                            <h2 class="text-sm font-semibold text-blue-800 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Basic Information
                            </h2>
                        </div>
                        <div class="p-4">
                            <div class="grid grid-cols-2 gap-3">
                                <div class="col-span-2">
                                    <label class="form-label">Hostname</label>
                                    {{ form.hostname }}
                                </div>
                                <div class="col-span-2">
                                    <label class="form-label">UUID</label>
                                    {{ form.uuid }}
                                </div>
                                <div>
                                    <label class="form-label">Status</label>
                                    {{ form.status }}
                                </div>
                                <div>
                                    <label class="form-label">Data Source</label>
                                    {{ form.data_source }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Network -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="px-4 py-2.5 bg-gradient-to-r from-cyan-100 to-teal-100 border-b border-cyan-200">
                            <h2 class="text-sm font-semibold text-cyan-800 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-cyan-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.288 15.038a5.25 5.25 0 017.424 0M5.106 11.856c3.807-3.808 9.98-3.808 13.788 0M1.924 8.674c5.565-5.565 14.587-5.565 20.152 0M12.53 18.22l-.53.53-.53-.53a.75.75 0 011.06 0z" />
                                </svg>
                                Network Configuration
                            </h2>
                        </div>
                        <div class="p-4">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="form-label">IP Address</label>
                                    {{ form.ip_address }}
                                </div>
                                <div>
                                    <label class="form-label">BMC IP</label>
                                    {{ form.bmc_ip }}
                                </div>
                                <div>
                                    <label class="form-label">NIC MAC</label>
                                    {{ form.nic_mac }}
                                </div>
                                <div>
                                    <label class="form-label">BMC MAC</label>
                                    {{ form.bmc_mac }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Row 2: Hardware + OS -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Hardware Specifications -->
                    <div class="lg:col-span-2 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="px-4 py-2.5 bg-gradient-to-r from-violet-100 to-purple-100 border-b border-violet-200">
                            <h2 class="text-sm font-semibold text-violet-800 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-violet-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                                </svg>
                                Hardware Specifications
                            </h2>
                        </div>
                        <div class="p-4">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div>
                                    <label class="form-label">Manufacturer</label>
                                    {{ form.manufacture }}
                                </div>
                                <div>
                                    <label class="form-label">Product Name</label>
                                    {{ form.product_name }}
                                </div>
                                <div>
                                    <label class="form-label">Device Type</label>
                                    {{ form.category }}
                                </div>
                                <div>
                                    <label class="form-label">CPU Model</label>
                                    {{ form.cpu }}
                                </div>
                                <div>
                                    <label class="form-label">Core Count</label>
                                    {{ form.core_count }}
                                </div>
                                <div>
                                    <label class="form-label">Sockets</label>
                                    {{ form.sockets }}
                                </div>
                                <div>
                                    <label class="form-label">Memory (GB)</label>
                                    {{ form.total_mem }}
                                </div>
                                <div>
                                    <label class="form-label">Disk Count</label>
                                    {{ form.disk_count }}
                                </div>
                                <div>
                                    <label class="form-label">BIOS Version</label>
                                    {{ form.bios_version }}
                                </div>
                                <div>
                                    <label class="form-label">BIOS Date</label>
                                    {{ form.bios_release_date }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Operating System -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="px-4 py-2.5 bg-gradient-to-r from-emerald-100 to-green-100 border-b border-emerald-200">
                            <h2 class="text-sm font-semibold text-emerald-800 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-emerald-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                Operating System
                            </h2>
                        </div>
                        <div class="p-4">
                            <div class="grid grid-cols-1 gap-3">
                                <div>
                                    <label class="form-label">OS</label>
                                    {{ form.os }}
                                </div>
                                <div>
                                    <label class="form-label">OS Version</label>
                                    {{ form.os_version }}
                                </div>
                                <div>
                                    <label class="form-label">Kernel</label>
                                    {{ form.kernel }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Row 3: Location + Ownership -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <!-- Physical Location & PDU -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="px-4 py-2.5 bg-gradient-to-r from-amber-100 to-orange-100 border-b border-amber-200">
                            <h2 class="text-sm font-semibold text-amber-800 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-amber-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                Physical Location & PDU
                            </h2>
                        </div>
                        <div class="p-4 space-y-3">
                            <div class="grid grid-cols-4 gap-3">
                                <div>
                                    <label class="form-label">Building</label>
                                    {{ form.building }}
                                </div>
                                <div>
                                    <label class="form-label">Room</label>
                                    {{ form.room }}
                                </div>
                                <div>
                                    <label class="form-label">Rack</label>
                                    {{ form.rack }}
                                </div>
                                <div>
                                    <label class="form-label">Position</label>
                                    {{ form.location }}
                                </div>
                            </div>
                            <div class="pt-2 border-t border-slate-100">
                                <div class="flex items-center gap-4">
                                    <label class="inline-flex items-center gap-2 cursor-pointer">
                                        {{ form.pdu_connection }}
                                        <span class="text-xs font-medium text-slate-600">PDU Connected</span>
                                    </label>
                                    <div id="pdu-extra" class="flex-1 grid grid-cols-2 gap-3 {% if not form.instance.pdu_connection %}hidden{% endif %}">
                                        <div>
                                            <label class="form-label">PDU IP</label>
                                            {{ form.pdu_ip }}
                                        </div>
                                        <div>
                                            <label class="form-label">Port #</label>
                                            {{ form.pdu_port_number }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ownership -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="px-4 py-2.5 bg-gradient-to-r from-rose-100 to-pink-100 border-b border-rose-200">
                            <h2 class="text-sm font-semibold text-rose-800 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-rose-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                                Ownership
                            </h2>
                        </div>
                        <div class="p-4">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="form-label">Assigned To</label>
                                    {{ form.assign_to }}
                                </div>
                                <div>
                                    <label class="form-label">Last Login</label>
                                    {{ form.last_login }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Row 4: Tags -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="px-4 py-2.5 bg-gradient-to-r from-sky-100 to-blue-100 border-b border-sky-200">
                        <h2 class="text-sm font-semibold text-sky-800 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-sky-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                            </svg>
                            Tags
                        </h2>
                    </div>
                    <div class="p-4">
                        <div class="flex flex-wrap gap-2">
                            {% for checkbox in form.tags %}
                            <label class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all has-[:checked]:bg-blue-100 has-[:checked]:border-blue-500 has-[:checked]:text-blue-800">
                                {{ checkbox.tag }}
                                <span class="text-xs font-medium">{{ checkbox.choice_label }}</span>
                            </label>
                            {% empty %}
                            <div class="text-center py-4 w-full">
                                <p class="text-sm text-slate-500 mb-2">No tags available</p>
                                <a class="text-sm text-blue-600 hover:text-blue-700 font-medium" href="{% url 'overwatch:tag_create' %}">
                                    + Create a tag
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>

<script>
    const pduCheckbox = document.getElementById('{{ form.pdu_connection.id_for_label }}');
    const pduExtra = document.getElementById('pdu-extra');
    const pduIpInput = document.getElementById('id_pdu_ip');
    const pduPortInput = document.getElementById('id_pdu_port_number');
    
    if (pduCheckbox && pduExtra) {
        const togglePdu = () => {
            if (pduCheckbox.checked) {
                pduExtra.classList.remove('hidden');
                // Mark fields as required
                if (pduIpInput) pduIpInput.setAttribute('required', 'required');
                if (pduPortInput) pduPortInput.setAttribute('required', 'required');
            } else {
                pduExtra.classList.add('hidden');
                // Remove required attribute and clear validation
                if (pduIpInput) {
                    pduIpInput.removeAttribute('required');
                    pduIpInput.classList.remove('border-red-500');
                }
                if (pduPortInput) {
                    pduPortInput.removeAttribute('required');
                    pduPortInput.classList.remove('border-red-500');
                }
            }
        };
        pduCheckbox.addEventListener('change', togglePdu);
        togglePdu();
    }
    
    // Form validation before submit
    document.getElementById('server-form').addEventListener('submit', function(e) {
        if (pduCheckbox && pduCheckbox.checked) {
            let isValid = true;
            
            if (pduIpInput && !pduIpInput.value.trim()) {
                pduIpInput.classList.add('border-red-500');
                isValid = false;
            } else if (pduIpInput) {
                pduIpInput.classList.remove('border-red-500');
            }
            
            if (pduPortInput && !pduPortInput.value.trim()) {
                pduPortInput.classList.add('border-red-500');
                isValid = false;
            } else if (pduPortInput) {
                pduPortInput.classList.remove('border-red-500');
            }
            
            if (!isValid) {
                e.preventDefault();
                alert('PDU IP and Port # are required when PDU Connection is enabled.');
            }
        }
    });
</script>

<style>
    .form-label {
        display: block;
        font-size: 11px;
        font-weight: 600;
        color: #475569;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    
    #server-form input[type="text"],
    #server-form input[type="number"],
    #server-form input[type="date"],
    #server-form select,
    #server-form textarea {
        width: 100%;
        font-size: 13px;
        padding: 6px 10px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        background-color: #f8fafc;
        color: #1e293b;
        outline: none;
        transition: all 0.15s ease;
    }
    
    #server-form input[type="text"]:hover,
    #server-form input[type="number"]:hover,
    #server-form input[type="date"]:hover,
    #server-form select:hover,
    #server-form textarea:hover {
        border-color: #cbd5e1;
        background-color: #fff;
    }
    
    #server-form input[type="text"]:focus,
    #server-form input[type="number"]:focus,
    #server-form input[type="date"]:focus,
    #server-form select:focus,
    #server-form textarea:focus {
        border-color: #3b82f6;
        background-color: #fff;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }
    
    #server-form input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: #3b82f6;
        cursor: pointer;
    }
    
    #server-form select {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 8px center;
        background-repeat: no-repeat;
        background-size: 16px;
        padding-right: 32px;
    }
</style>
{% endblock %}
